import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// scripts/.. => repo root
const rootDir = path.resolve(__dirname, "..");
const outDir = path.join(rootDir, "src", "generated");
const outFile = path.join(outDir, "huge-data.ts");

// Default: ~8MB of payload (adjust with HUGE_BYTES)
const targetBytes = Number.parseInt(process.env.HUGE_BYTES ?? "8000000", 10);

if (!Number.isFinite(targetBytes) || targetBytes <= 0) {
  throw new Error(`Invalid HUGE_BYTES: ${process.env.HUGE_BYTES}`);
}

const alphabet =
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
const lineLen = 200;

let remaining = targetBytes;
const lines = [];

while (remaining > 0) {
  const take = Math.min(remaining, lineLen);
  const line = alphabet.repeat(Math.ceil(take / alphabet.length)).slice(
    0,
    take,
  );
  lines.push(line);
  remaining -= take;
}

const payload = lines.join("\n");

const contents = `/* AUTO-GENERATED by scripts/generate-huge-module.mjs
 * This file intentionally bloats the client bundle for testing.
 * Regenerate with: HUGE_BYTES=20000000 npm run generate:huge
 */
export const hugeData = ${JSON.stringify(payload)} as const;
export const hugeDataBytes = hugeData.length;
`;

await fs.mkdir(outDir, { recursive: true });
await fs.writeFile(outFile, contents, "utf8");

console.log(`Wrote ${outFile} (~${payload.length} chars payload)`);
